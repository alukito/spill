<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Split Bill</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <style>
      .container {
        max-width: 720px;
      }
      .fs-7 {
        font-size: 0.8rem;
      }
      #itemsInput {
        overflow: hidden;
      }
    </style>
  </head>

  <body class="bg-light-subtle">
    <div class="container" x-data="spill">
      <h4 class="my-4 fw-bold">Split Bill</h4>

      <div class="mt-3">
        <label for="totalInput" class="form-label">Total</label>
        <input id="totalInput" type="number" class="form-control" x-model="total"></input>
      </div>
      <div class="mt-3">
        <label for="itemsInput" class="form-label">Items</label>
        <textarea id="itemsInput" class="form-control" rows="5" x-model="items"></textarea>
      </div>
      <div class="mt-3">
        <button type="button" class="btn btn-danger" @click="clear">Clear</button>
      </div>

      <div class="text-danger my-4" x-text="error" x-if="error"></div>
      <template x-if="parsedData">
        <div class="table-responsive my-4">
          <table class="table table-sm fs-7 text-end bg-white">
            <tr class="table-dark">
              <th class="text-start">NO.</th>
              <th>PRICE</th>
              <th>+&nbsp;FEE&nbsp;(<span x-text="formatNumber(parsedData.feePercentage)"></span>%)</th>
              <template x-for="person in parsedData.people">
                <th x-text="person"></th>
              </template>
            </tr>
            <template x-for="item in parsedData.items">
              <tr>
                <td class="table-secondary text-start" x-text="item.no"></td>
                <td class="table-secondary" x-text="formatNumber(item.price)"></td>
                <td class="table-secondary" x-text="formatNumber(item.priceWithFee)"></td>
                <template x-for="person in parsedData.people">
                  <td x-text="formatNumber(item.people[person])"></td>
                </template>
              </tr>
            </template>
            <tr>
              <th class="table-secondary"></th>
              <th class="table-secondary" x-text="formatNumber(parsedData.totalPrice)"></th>
              <th class="table-secondary" x-text="formatNumber(parsedData.totalPriceWithFee)")></th>
              <template x-for="person in parsedData.people">
                <th class="table-success" x-text="formatNumber(parsedData.peopleTotal[person])"></th>
              </template>
            </tr>
          </table>
        </div>
      </template>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      // Text area auto-resize
      const textarea = document.getElementById('itemsInput');
      const autoResize = () => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      };
      textarea.addEventListener('input', autoResize, false);
      autoResize();

      // Alpine data
      document.addEventListener('alpine:init', () => {
        Alpine.data('spill', () => ({
          total: '73150',
          items: '30000 A\n27500 B\n9000 A, A, B',
          error: null,
          parsedData: null,

          compute() {
            console.log('x');
            try {
              // Parse total
              const total = parseInt(this.total.trim());
              if (!(total > 0)) {
                throw Error('Total is invalid');
              }

              // Parse items
              const peopleTotal = {};
              let proratedTotal = 0;
              const items = this.items
                .split('\n')
                .map((item) => item.trim().toUpperCase())
                .filter((item) => item)
                .map((item, itemIndex) => {
                  const spaceIndex = item.indexOf(' ');
                  if (spaceIndex < 0) {
                    throw Error(`Item ${itemIndex + 1} is incomplete`);
                  }

                  // Parse price
                  const price = parseInt(item.slice(0, spaceIndex));
                  if (!(price > 0)) {
                    throw Error(`Item ${itemIndex + 1} has invalid price`);
                  }

                  // Parse people
                  const people = item
                    .slice(spaceIndex)
                    .split(',')
                    .map((name) => name.trim())
                    .filter((name) => name);
                  const proratedPrice = Math.round(price / people.length);
                  proratedTotal += proratedPrice * people.length;
                  const result = {
                    no: itemIndex + 1,
                    price: price,
                    priceWithFee: null,
                    people: {}
                  };
                  people.forEach((person) => {
                    result.people[person] = (result.people[person] || 0) + proratedPrice;
                    peopleTotal[person] = 0;
                  });
                  return result;
                });

              // Calculate and apply fee
              let totalPrice = 0;
              let totalPriceWithFee = 0;
              const feePercentage = (total - proratedTotal) / proratedTotal;
              items.forEach((item) => {
                item.priceWithFee = Math.round(item.price * (1 + feePercentage));
                Object.keys(item.people).forEach((person) => {
                  item.people[person] = Math.round(item.people[person] * (1 + feePercentage));
                  peopleTotal[person] += item.people[person];
                });
                totalPrice += item.price;
                totalPriceWithFee += item.priceWithFee;
              });

              this.error = null;
              this.parsedData = {
                people: Object.keys(peopleTotal).sort(),
                feePercentage: Math.round(feePercentage * 1000) / 10,
                items,
                totalPrice,
                totalPriceWithFee,
                peopleTotal
              };
            }
            catch (e) {
              this.error = e.message;
              this.parsedData = null;
            }
          },
          clear() {
            if (confirm('Are you sure?')) {
              this.total = '';
              this.items = '';
            }
          },
          formatNumber(num) {
            return num != null ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') : '';
          },

          init() {
            this.compute();
            this.$watch('total', () => this.compute());
            this.$watch('items', () => this.compute());
          },
        }));
      });
    </script>
  </body>
</html>
